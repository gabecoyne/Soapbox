class NimitzPluginGenerator < Rails::Generators::NamedBase
  
  argument :attributes, :type => :array, :default => [], :banner => "field:type field:type"
  
  def self.source_root
    File.join(File.dirname(__FILE__), 'templates')
  end
  
  def manifest
      # Copy controller, model and migration
      directories = [
        "vendor/plugins/nimitz_#{plural_name}", 
        "vendor/plugins/nimitz_#{plural_name}/app",
        "vendor/plugins/nimitz_#{plural_name}/app/controllers",
        "vendor/plugins/nimitz_#{plural_name}/app/controllers/admin", 
        "vendor/plugins/nimitz_#{plural_name}/app/models", 
        "vendor/plugins/nimitz_#{plural_name}/app/views",
        "vendor/plugins/nimitz_#{plural_name}/app/helpers",
        "vendor/plugins/nimitz_#{plural_name}/app/views/admin",
        "vendor/plugins/nimitz_#{plural_name}/config",
        "vendor/plugins/nimitz_#{plural_name}/db",
        "vendor/plugins/nimitz_#{plural_name}/db/migrate"
      ]      

      directories.each do |dir|
        empty_directory dir
      end
      
      template "controller.rb", "vendor/plugins/nimitz_#{plural_name}/app/controllers/admin/#{plural_name}_controller.rb"
      template "model.rb", "vendor/plugins/nimitz_#{plural_name}/app/models/#{singular_name}.rb"
      template "config/routes.rb", "vendor/plugins/nimitz_#{plural_name}/config/routes.rb"
      
      # Create migration
      migration_name = "#{Time.now.strftime('%Y%m%d%H%M%S')}_create_#{singular_name.pluralize}.rb"
      template 'migration.rb', "db/migrate/#{migration_name}"
      template 'migration.rb', "vendor/plugins/nimitz_#{plural_name}/db/migrate/#{migration_name}"
      
      # Create view directory
      admin_view_dir = File.join("vendor/plugins/nimitz_#{plural_name}/app/views/admin", plural_name)
      empty_directory admin_view_dir
      
      # Copy in all views
      admin_view_files = ['_form.html.erb', 'edit.html.erb', 'new.html.erb', 'index.html.erb' ]
      admin_view_files.each do |view_file|
        template "views/admin/#{view_file}", "#{admin_view_dir}/#{view_file}"
      end
      
      puts "IMPORTANT"
      puts "---------------------------------------"
      puts "Now run 'rake db:migrate' to add the table to the DB"
      puts "---------------------------------------"
  end
end